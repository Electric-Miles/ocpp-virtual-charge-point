<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Virtual Charge Point Control</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/css/app.css">
  </head>
  <body class="bg-[#f4f4f4] min-h-full flex flex-col">
    <div class="flex-1">
      <div class="max-w-screen-lg mx-auto p-5">
        <div class="p-5 bg-white rounded-lg shadow-sm">
          <h1 class="text-3xl">Virtual Charge Point Control</h1>

          <div class="my-5">
            Hi <span id="first_name"></span>,
            <button id="logout" class="link link-primary">Log out</button>
          </div>

          <div class="tabs tabs-box">
            <input type="radio" name="my_tabs_2" class="tab" aria-label="Start VCPs" checked />

            <div id="startVCP" class="tab-content bg-base-100 border-base-300 p-5">
              <form id="startVCPForm" class="space-y-4">
                <div>
                  <label class="block mb-2 label">
                    Charge Point ID <span class="optional">(optional)</span>
                  </label>
                  <input type="text" id="chargePointId" class="w-full input" placeholder="VCP_ALAN_01"/>
                  <span class="mt-0.5 block text-sm text-base-content/60">Required if ID prefix is not provided.</span>
                </div>

                <div>
                  <label class="block mb-2 label">
                    ID Prefix <span class="optional">(optional)</span>
                  </label>
                  <input type="text" id="idPrefix" class="w-full input" placeholder="VCP_TEST_"/>
                  <span class="mt-0.5 block text-sm text-base-content/60">Required if charge point ID is not provided.</span>
                </div>

                <div>
                  <label class="block mb-2 label">
                    Count <span class="optional">(optional)</span>
                  </label>
                  <input type="number" class="w-full input" id="count" min="1" />
                  <span class="mt-0.5 block text-sm text-base-content/60">Required if ID prefix is provided.</span>
                </div>

              <div>
                <label class="block mb-2 label">Endpoint</label>
                <select id="endpoint" class="w-full select" required>
                  <option value="ws://ocpp.test.electricmiles.io">Test</option>
                  <option value="ws://127.0.0.1:9000">Local</option>
                  <option value="ws://ocpp.stage1.electricmiles.io">
                    Stage 1
                  </option>
                  <option value="ws://ocpp.stage2.electricmiles.io">
                    Stage 2
                  </option>
                  <option value="ws://ocpp.stage3.electricmiles.io">
                    Stage 3
                  </option>
                  <option value="ws://ocpp.electricmiles.io">Production</option>
                  <option value="ws://ocpp.monta.app">Monta</option>
                </select>
              </div>

                <div>
                  <label class="block mb-2 label">
                    Start Chance <span class="optional">(optional)</span>
                  </label>
                  <input type="number" id="startChance" class="w-full input" placeholder="20" min="1" />
                  <span class="mt-0.5 block text-sm text-base-content/60">Required when starting multiple VCPs.</span>
                </div>

                <div class="flex items-center space-x-4">
                  <label for="testCharge" class="label">
                  Test Charge <span class="optional">(optional)</span>
                  </label>
                  <input type="checkbox" class="checkbox" id="testCharge" />
                </div>

                <div>
                  <label class="block mb-2 label">Duration</label>
                  <input type="number" id="duration" class="w-full input" value="1000" min="1" required />
                </div>

                <div>
                  <div class="flex items-center space-x-4">
                    <label for="randomDelay" class="label">
                      Random Delay <span class="optional">(optional)</span>
                    </label>
                    <input type="checkbox" id="randomDelay" class="checkbox" />
                  </div>
                  <span class="mt-0.5 block text-sm text-base-content/60">Required when starting multiple VCPs.</span>
                </div>

                <div class="flex items-center space-x-4">
                  <label for="isTwinGun" class="label">
                    Is Twin Gun <span class="optional">(optional)</span>
                  </label>
                  <input type="checkbox" id="isTwinGun" class="checkbox" />
                </div>
                  
                <div>
                  <label class="block mb-2 label">
                    sleep Time <span class="optional">(optional)</span>
                  </label>
                  <input type="number" id="sleepTime" class="w-full input" placeholder="500" min="500" />
                  <span class="mt-0.5 block text-sm text-base-content/60">Required when is twin gun.</span>
                </div>

                <div>
                  <label class="block mb-2 label">OCPP Version</label>
                  <select id="ocppVersion" class="w-full select" required>
                    <option value="OCPP_1.6">OCPP_1.6</option>
                    <option value="OCPP_2.0.1">OCPP_2.0.1</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-primary btn-block">Start</button>
              </form>
            </div>

            <input type="radio" name="my_tabs_2" class="tab" aria-label="Change Status" />

            <div id="changeStatus" class="tab-content bg-base-100 border-base-300 p-5">
              <form id="changeStatusForm" class="space-y-4">
                <div>
                  <label class="block mb-2 label">Charge Point ID</label>
                  <input type="text" id="statusChargePointId" class="w-full input" placeholder="VCP_ALAN_01" required />
                </div>
            
                <div>
                  <label class="block mb-2 label">connectorId</label>
                  <input type="number" id="connectorId" class="w-full input" value="1" min="1" required />
                </div>
            
                <div>
                  <label class="block mb-2 label">Status</label>
                  <select id="status" class="w-full select" required>
                    <option value="Available">Available</option>
                    <option value="Charging">Charging</option>
                    <option value="Faulted">Faulted</option>
                    <option value="Finishing">Finishing</option>
                    <option value="Preparing">Preparing</option>
                    <option value="Reserved">Reserved</option>
                    <option value="SuspendedEV">SuspendedEV</option>
                    <option value="SuspendedEVSE">SuspendedEVSE</option>
                  </select>
                </div>
            
                <div>
                  <label class="block mb-2 label">Error Code</label>
                  <select id="errorCode" class="w-full select" required>
                    <option value="NoError">NoError</option>
                    <option value="InternalError">InternalError</option>
                    <option value="EVCommunicationError">EVCommunicationError</option>
                    <option value="PeakWait">PeakWait</option>
                  </select>
                </div>
            
                <button type="submit" class="btn btn-primary btn-block">Change Status</button>
              </form>
            </div>

            <input type="radio" name="my_tabs_2" class="tab" aria-label="Stop VCPs" />

            <div id="stopVCP" class="tab-content bg-base-100 border-base-300 p-5">
              <form id="stopVCPForm" class="space-y-4">
                <div>
                  <label class="block mb-2 label">
                    VCP ID <span class="optional">(optional)</span>
                  </label>
                  <input type="text" id="vcpId" class="w-full input" placeholder="VCP_ALAN_01" />
                </div>
            
                <div>
                  <label class="block mb-2 label">
                    VCP ID Prefix <span class="optional">(optional)</span>
                  </label>
                  <input type="text" id="vcpIdPrefix" class="w-full input" placeholder="VCP_TEST_" />
                </div>
            
                <p class="mt-0.5 block text-sm text-base-content/60">
                  If neither VCP ID nor VCP ID prefix is provided, all running VCPs
                  will be stopped.
                </p>
            
                <button type="submit" class="btn btn-primary btn-block">Stop</button>
              </form>
            </div>
            
            <input type="radio" name="my_tabs_2" class="tab" aria-label="Get Status" />

            <div id="getStatus" class="tab-content bg-base-100 border-base-300 p-5">
              <button class="btn btn-primary btn-block" onclick="getVCPStatus()">Get Status</button>
            </div>
          </div>

          <div class="divider"></div>

          <div>
            <h2>Response</h2>
            <pre id="response"></pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      window.addEventListener("load", (event) => {
        fetch("/api/auth/user", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("vcp_access_token")}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status !== "success") {
              window.location.href = "/login";
            } else {
              document.getElementById("first_name").textContent =
                data.data.first_name;
            }
          })
          .catch((error) => {
            console.error(error);
          });
      });

      function openTab(event, tabId) {
        document.querySelectorAll(".tab-content").forEach((tab) => tab.classList.remove("active"));
        document.querySelectorAll(".tab").forEach((tab) => tab.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        event.currentTarget.classList.add("active");
      }

      async function sendRequest(url, method, body = null) {
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("vcp_access_token")}`,
          },
          body: body ? JSON.stringify(body) : null,
        };
        const response = await fetch(url, options);
        const data = await response.json();
        document.getElementById("response").textContent = JSON.stringify(
          data,
          null,
          2,
        );
      }

      document
        .getElementById("startVCPForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const chargePointId = document.getElementById("chargePointId").value;
          const idPrefix = document.getElementById("idPrefix").value;

          if (chargePointId) {
            localStorage.setItem("chargePointId", chargePointId);
          }

          if (idPrefix) {
            localStorage.setItem("idPrefix", idPrefix);
          }

          document.getElementById("statusChargePointId").value =
            chargePointId ?? idPrefix;
          document.getElementById("vcpId").value = chargePointId;
          document.getElementById("vcpIdPrefix").value = idPrefix;

          sendRequest("/api/vcp/start", "POST", {
            chargePointId,
            idPrefix,
            count: Number(document.getElementById("count").value),
            endpoint: document.getElementById("endpoint").value,
            startChance: Number(document.getElementById("startChance").value),
            testCharge: document.getElementById("testCharge").checked,
            duration: Number(document.getElementById("duration").value),
            randomDelay: document.getElementById("randomDelay").checked,
            isTwinGun: document.getElementById("isTwinGun").checked,
            sleepTime: Number(document.getElementById("sleepTime").value),
            ocppVersion: document.getElementById("ocppVersion").value,
          });
        });

      document
        .getElementById("changeStatusForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          sendRequest("/api/vcp/change-status", "POST", {
            chargePointId: document.getElementById("statusChargePointId").value,
            action: "StatusNotification",
            payload: {
              connectorId: Number(document.getElementById("connectorId").value),
              status: document.getElementById("status").value,
              errorCode: document.getElementById("errorCode").value,
            },
          });
        });

      document
        .getElementById("stopVCPForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          sendRequest("/api/vcp/stop", "POST", {
            vcpId: document.getElementById("vcpId").value,
            vcpIdPrefix: document.getElementById("vcpIdPrefix").value,
          });
        });

      function getVCPStatus() {
        sendRequest("/api/vcp/status?verbose=true", "GET");
      }

      document.getElementById("logout").addEventListener("click", (event) => {
        event.preventDefault();

        localStorage.removeItem("vcp_access_token");

        window.location.href = "/login";
      });
    </script>
  </body>
</html>
